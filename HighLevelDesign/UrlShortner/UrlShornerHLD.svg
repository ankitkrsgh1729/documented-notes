<svg viewBox="0 0 1600 1200" xmlns="http://www.w3.org/2000/svg">
    <!-- Background -->
    <rect width="1600" height="1200" fill="#f8f9fa"/>
    
    <!-- Title -->
    <text x="800" y="50" text-anchor="middle" font-size="28" font-weight="bold" fill="#2c3e50">
        URL Shortener - Distributed Architecture
    </text>
    
    <!-- Components -->
    <!-- Client -->
    <rect x="100" y="400" width="120" height="80" rx="10" ry="10" fill="#bbdefb" stroke="#1565c0" stroke-width="2"/>
    <text x="160" y="445" text-anchor="middle" font-size="18" fill="#1565c0">Client</text>
    
    <!-- CDN -->
    <rect x="300" y="250" width="120" height="80" rx="10" ry="10" fill="#ffcc80" stroke="#e65100" stroke-width="2"/>
    <text x="360" y="295" text-anchor="middle" font-size="18" fill="#e65100">CDN</text>
    
    <!-- API Gateway -->
    <rect x="300" y="400" width="200" height="200" rx="10" ry="10" fill="#ce93d8" stroke="#7b1fa2" stroke-width="2"/>
    <text x="400" y="430" text-anchor="middle" font-size="20" font-weight="bold" fill="#7b1fa2">API Gateway</text>
    
    <!-- API Gateway internals -->
    <rect x="320" y="450" width="160" height="30" rx="5" ry="5" fill="#e1bee7" stroke="#8e24aa" stroke-width="1"/>
    <text x="400" y="470" text-anchor="middle" font-size="14" fill="#7b1fa2">Token Validation</text>
    
    <rect x="320" y="490" width="160" height="30" rx="5" ry="5" fill="#e1bee7" stroke="#8e24aa" stroke-width="1"/>
    <text x="400" y="510" text-anchor="middle" font-size="14" fill="#7b1fa2">Rate Limiting</text>
    
    <rect x="320" y="530" width="160" height="30" rx="5" ry="5" fill="#e1bee7" stroke="#8e24aa" stroke-width="1"/>
    <text x="400" y="550" text-anchor="middle" font-size="14" fill="#7b1fa2">Request Routing</text>
    
    <rect x="320" y="570" width="160" height="20" rx="5" ry="5" fill="#e1bee7" stroke="#8e24aa" stroke-width="1"/>
    <text x="400" y="585" text-anchor="middle" font-size="12" fill="#7b1fa2">Response Transformation</text>
    
    <!-- URL Shortener Services -->
    <rect x="650" y="250" width="160" height="100" rx="10" ry="10" fill="#c5e1a5" stroke="#33691e" stroke-width="2"/>
    <text x="730" y="280" text-anchor="middle" font-size="18" fill="#33691e">URL Shortener</text>
    <text x="730" y="305" text-anchor="middle" font-size="16" fill="#33691e">/api/v1/shorten</text>
    <text x="730" y="330" text-anchor="middle" font-size="14" fill="#33691e">Multiple Instances</text>
    
    <!-- URL Redirect Services -->
    <rect x="650" y="380" width="160" height="100" rx="10" ry="10" fill="#c5e1a5" stroke="#33691e" stroke-width="2"/>
    <text x="730" y="410" text-anchor="middle" font-size="18" fill="#33691e">URL Redirect</text>
    <text x="730" y="435" text-anchor="middle" font-size="16" fill="#33691e">/api/v1/{code}</text>
    <text x="730" y="460" text-anchor="middle" font-size="14" fill="#33691e">Multiple Instances</text>
    
    <!-- Analytics Services -->
    <rect x="650" y="510" width="160" height="100" rx="10" ry="10" fill="#f8bbd0" stroke="#ad1457" stroke-width="2"/>
    <text x="730" y="540" text-anchor="middle" font-size="18" fill="#ad1457">Analytics API</text>
    <text x="730" y="565" text-anchor="middle" font-size="16" fill="#ad1457">/api/v1/analytics</text>
    <text x="730" y="590" text-anchor="middle" font-size="14" fill="#ad1457">Multiple Instances</text>
    
    <!-- Custom URL Services -->
    <rect x="650" y="640" width="160" height="100" rx="10" ry="10" fill="#c5e1a5" stroke="#33691e" stroke-width="2"/>
    <text x="730" y="670" text-anchor="middle" font-size="18" fill="#33691e">Custom URL</text>
    <text x="730" y="695" text-anchor="middle" font-size="16" fill="#33691e">/api/v2/custom</text>
    <text x="730" y="720" text-anchor="middle" font-size="14" fill="#33691e">Multiple Instances</text>
    
    <!-- Redis Cache Cluster -->
    <rect x="900" y="320" width="200" height="150" rx="10" ry="10" fill="#b2dfdb" stroke="#00695c" stroke-width="2"/>
    <text x="1000" y="345" text-anchor="middle" font-size="20" font-weight="bold" fill="#00695c">Redis Cluster</text>
    
    <!-- Redis nodes -->
    <circle cx="940" cy="390" r="30" fill="#80cbc4" stroke="#00695c" stroke-width="1.5"/>
    <text x="940" y="395" text-anchor="middle" font-size="14" fill="#00695c">Master</text>
    
    <circle cx="1020" cy="390" r="20" fill="#80cbc4" stroke="#00695c" stroke-width="1.5"/>
    <text x="1020" y="395" text-anchor="middle" font-size="12" fill="#00695c">Replica</text>
    
    <circle cx="940" cy="450" r="20" fill="#80cbc4" stroke="#00695c" stroke-width="1.5"/>
    <text x="940" y="455" text-anchor="middle" font-size="12" fill="#00695c">Master</text>
    
    <circle cx="1020" cy="450" r="30" fill="#80cbc4" stroke="#00695c" stroke-width="1.5"/>
    <text x="1020" y="455" text-anchor="middle" font-size="14" fill="#00695c">Replica</text>
    
    <line x1="940" y1="420" x2="1020" y2="420" stroke="#00695c" stroke-width="1" stroke-dasharray="5,3"/>
    <line x1="970" y1="390" x2="970" y2="450" stroke="#00695c" stroke-width="1" stroke-dasharray="5,3"/>
    <line x1="990" y1="390" x2="990" y2="450" stroke="#00695c" stroke-width="1" stroke-dasharray="5,3"/>
    
    <!-- Database Proxy -->
    <rect x="1150" y="320" width="150" height="150" rx="10" ry="10" fill="#ffe0b2" stroke="#e65100" stroke-width="2"/>
    <text x="1225" y="345" text-anchor="middle" font-size="20" font-weight="bold" fill="#e65100">DB Proxy</text>
    
    <!-- DB Proxy internals -->
    <rect x="1170" y="365" width="110" height="30" rx="5" ry="5" fill="#ffcc80" stroke="#ef6c00" stroke-width="1"/>
    <text x="1225" y="385" text-anchor="middle" font-size="14" fill="#e65100">Shard Router</text>
    
    <rect x="1170" y="405" width="110" height="30" rx="5" ry="5" fill="#ffcc80" stroke="#ef6c00" stroke-width="1"/>
    <text x="1225" y="425" text-anchor="middle" font-size="14" fill="#e65100">Connection Pool</text>
    
    <rect x="1170" y="445" width="110" height="15" rx="5" ry="5" fill="#ffcc80" stroke="#ef6c00" stroke-width="1"/>
    <text x="1225" y="457" text-anchor="middle" font-size="10" fill="#e65100">Query Cache</text>
    
    <!-- Database Cluster -->
    <circle cx="1400" cy="300" r="50" fill="#ffecb3" stroke="#ff6f00" stroke-width="2"/>
    <text x="1400" y="290" text-anchor="middle" font-size="16" fill="#ff6f00">DB</text>
    <text x="1400" y="315" text-anchor="middle" font-size="14" fill="#ff6f00">Shard 1</text>
    
    <circle cx="1400" cy="440" r="50" fill="#ffecb3" stroke="#ff6f00" stroke-width="2"/>
    <text x="1400" y="430" text-anchor="middle" font-size="16" fill="#ff6f00">DB</text>
    <text x="1400" y="455" text-anchor="middle" font-size="14" fill="#ff6f00">Shard 2</text>
    
    <circle cx="1400" cy="580" r="50" fill="#ffecb3" stroke="#ff6f00" stroke-width="2"/>
    <text x="1400" y="570" text-anchor="middle" font-size="16" fill="#ff6f00">DB</text>
    <text x="1400" y="595" text-anchor="middle" font-size="14" fill="#ff6f00">Shard 3</text>
    
    <!-- Message Queue -->
    <rect x="900" y="550" width="200" height="100" rx="10" ry="10" fill="#c8e6c9" stroke="#2e7d32" stroke-width="2"/>
    <text x="1000" y="590" text-anchor="middle" font-size="18" fill="#2e7d32">Message Queue</text>
    <text x="1000" y="615" text-anchor="middle" font-size="16" fill="#2e7d32">(Kafka/RabbitMQ)</text>
    
    <!-- Analytics Processing Service -->
    <rect x="900" y="700" width="200" height="80" rx="10" ry="10" fill="#f8bbd0" stroke="#ad1457" stroke-width="2"/>
    <text x="1000" y="740" text-anchor="middle" font-size="18" fill="#ad1457">Analytics Processor</text>
    
    <!-- Analytics DB -->
    <circle cx="1150" cy="740" r="50" fill="#d1c4e9" stroke="#4527a0" stroke-width="2"/>
    <text x="1150" y="740" text-anchor="middle" font-size="18" fill="#4527a0">Analytics</text>
    <text x="1150" y="765" text-anchor="middle" font-size="16" fill="#4527a0">DB</text>
    
    <!-- Auth Service -->
    <rect x="300" y="700" width="200" height="100" rx="10" ry="10" fill="#ffecb3" stroke="#ff6f00" stroke-width="2"/>
    <text x="400" y="730" text-anchor="middle" font-size="20" font-weight="bold" fill="#ff6f00">Auth Service</text>
    <text x="400" y="760" text-anchor="middle" font-size="16" fill="#ff6f00">/api/v1/auth</text>
    
    <!-- Auth DB -->
    <circle cx="150" cy="750" r="40" fill="#ffe0b2" stroke="#e65100" stroke-width="2"/>
    <text x="150" y="755" text-anchor="middle" font-size="16" fill="#e65100">Auth DB</text>
    
    <!-- Arrows and Flow -->
    <defs>
        <!-- Regular arrow -->
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#546e7a"/>
        </marker>
        
        <!-- Colored arrows -->
        <marker id="cache-arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#00695c"/>
        </marker>
        <marker id="event-arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#ad1457"/>
        </marker>
        <marker id="db-arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#e65100"/>
        </marker>
    </defs>
    
    <!-- Client to CDN/API Gateway -->
    <line x1="220" y1="400" x2="290" y2="290" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="230" y="330" text-anchor="middle" font-size="14" fill="#546e7a">Static Content</text>
    
    <line x1="220" y1="440" x2="290" y2="440" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="255" y="425" text-anchor="middle" font-size="14" fill="#546e7a">API Requests</text>
    
    <!-- CDN to Client -->
    <line x1="290" y1="310" x2="220" y2="390" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    
    <!-- API Gateway to URL Services -->
    <line x1="500" y1="430" x2="640" y2="300" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="550" y="340" text-anchor="middle" font-size="14" fill="#546e7a">Route to URL Shortener</text>
    
    <line x1="500" y1="470" x2="640" y2="430" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="570" y="430" text-anchor="middle" font-size="14" fill="#546e7a">Route to URL Redirect</text>
    
    <line x1="500" y1="510" x2="640" y2="550" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="570" y="510" text-anchor="middle" font-size="14" fill="#546e7a">Route to Analytics API</text>
    
    <line x1="500" y1="550" x2="640" y2="680" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="570" y="590" text-anchor="middle" font-size="14" fill="#546e7a">Route to Custom URL (v2)</text>
    
    <!-- API Gateway to Auth Service -->
    <line x1="400" y1="600" x2="400" y2="690" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="420" y="650" text-anchor="middle" font-size="14" fill="#546e7a">Auth Requests</text>
    
    <!-- Auth Service to API Gateway -->
    <line x1="380" y1="690" x2="380" y2="610" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="340" y="650" text-anchor="middle" font-size="14" fill="#546e7a">JWT Tokens</text>
    
    <!-- Auth Service to Auth DB -->
    <line x1="300" y1="750" x2="200" y2="750" stroke="#546e7a" stroke-width="2" marker-end="url(#arrowhead)"/>
    
    <!-- IMPROVED URL Services to Redis Cache connections -->
    <line x1="810" y1="290" x2="890" y2="340" stroke="#00695c" stroke-width="2.5" marker-end="url(#cache-arrow)"/>
    <text x="870" y="300" text-anchor="middle" font-size="14" fill="#00695c">1. Check URL</text>
    
    <line x1="890" y1="320" x2="820" y2="270" stroke="#00695c" stroke-width="2.5" marker-end="url(#cache-arrow)"/>
    <text x="845" y="270" text-anchor="middle" font-size="14" fill="#00695c">2. Cache Result</text>
    
    <line x1="810" y1="400" x2="890" y2="380" stroke="#00695c" stroke-width="2.5" marker-end="url(#cache-arrow)"/>
    <text x="850" y="370" text-anchor="middle" font-size="14" fill="#00695c">3. Lookup Code</text>
    
    <line x1="890" y1="400" x2="820" y2="430" stroke="#00695c" stroke-width="2.5" marker-end="url(#cache-arrow)"/>
    <text x="855" y="440" text-anchor="middle" font-size="14" fill="#00695c">4. Return URL</text>
    
    <!-- Redis Cache to DB Proxy -->
    <line x1="1100" y1="380" x2="1140" y2="380" stroke="#e65100" stroke-width="2.5" marker-end="url(#db-arrow)"/>
    <text x="1120" y="365" text-anchor="middle" font-size="14" fill="#e65100">Cache Miss</text>
    
    <!-- DB Proxy to Redis Cache -->
    <line x1="1140" y1="410" x2="1110" y2="410" stroke="#e65100" stroke-width="2.5" marker-end="url(#db-arrow)"/>
    <text x="1125" y="430" text-anchor="middle" font-size="14" fill="#e65100">Update Cache</text>
    
    <!-- DB Proxy to DB Shards -->
    <line x1="1300" y1="340" x2="1340" y2="310" stroke="#e65100" stroke-width="2" marker-end="url(#db-arrow)"/>
    <line x1="1300" y1="400" x2="1340" y2="420" stroke="#e65100" stroke-width="2" marker-end="url(#db-arrow)"/>
    <line x1="1300" y1="460" x2="1340" y2="540" stroke="#e65100" stroke-width="2" marker-end="url(#db-arrow)"/>
    
    <!-- IMPROVED URL Services to Message Queue connections -->
    <line x1="730" y1="350" x2="730" y2="520" stroke="#ad1457" stroke-width="2.5" stroke-dasharray="6,3"/>
    <line x1="730" y1="520" x2="890" y2="570" stroke="#ad1457" stroke-width="2.5" marker-end="url(#event-arrow)"/>
    <text x="810" y="550" text-anchor="middle" font-size="14" fill="#ad1457">URL Created Event</text>
    
    <line x1="770" y1="480" x2="770" y2="540" stroke="#ad1457" stroke-width="2.5" stroke-dasharray="6,3"/>
    <line x1="770" y1="540" x2="890" y2="590" stroke="#ad1457" stroke-width="2.5" marker-end="url(#event-arrow)"/>
    <text x="830" y="590" text-anchor="middle" font-size="14" fill="#ad1457">URL Accessed Event</text>
    
    <!-- Message Queue to Analytics Processor -->
    <line x1="1000" y1="650" x2="1000" y2="690" stroke="#ad1457" stroke-width="2" marker-end="url(#event-arrow)"/>
    <text x="1030" y="670" text-anchor="middle" font-size="14" fill="#ad1457">Consume Events</text>
    
    <!-- Analytics Processor to Analytics DB -->
    <line x1="1100" y1="740" x2="1090" y2="740" stroke="#4527a0" stroke-width="2" marker-end="url(#arrowhead)"/>
    
    <!-- Analytics API to Analytics DB -->
    <line x1="810" y1="560" x2="1090" y2="710" stroke="#4527a0" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="950" y="620" text-anchor="middle" font-size="14" fill="#4527a0">Query Analytics</text>
    
    <!-- Architectural Notes -->
    <!-- API Gateway Note -->
    <rect x="50" y="200" width="200" height="150" rx="5" ry="5" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="1"/>
    <text x="150" y="220" text-anchor="middle" font-size="16" font-weight="bold" fill="#424242">API Gateway</text>
    <text x="150" y="245" text-anchor="middle" font-size="12" fill="#424242">• Handles token validation</text>
    <text x="150" y="265" text-anchor="middle" font-size="12" fill="#424242">• Routes by service &amp; version</text>
    <text x="150" y="285" text-anchor="middle" font-size="12" fill="#424242">• Implements rate limiting</text>
    <text x="150" y="305" text-anchor="middle" font-size="12" fill="#424242">• Transforms requests/responses</text>
    <text x="150" y="325" text-anchor="middle" font-size="12" fill="#424242">• Hosts API documentation</text>
    
    <!-- Redis Note -->
    <rect x="900" y="200" width="200" height="100" rx="5" ry="5" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="1"/>
    <text x="1000" y="220" text-anchor="middle" font-size="16" font-weight="bold" fill="#424242">Redis Cluster</text>
    <text x="1000" y="245" text-anchor="middle" font-size="12" fill="#424242">• Handles power-law distribution</text>
    <text x="1000" y="265" text-anchor="middle" font-size="12" fill="#424242">• Master-replica for redundancy</text>
    <text x="1000" y="285" text-anchor="middle" font-size="12" fill="#424242">• Sharded for horizontal scaling</text>
    
    <!-- DB Proxy Note -->
    <rect x="1150" y="200" width="200" height="100" rx="5" ry="5" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="1"/>
    <text x="1250" y="220" text-anchor="middle" font-size="16" font-weight="bold" fill="#424242">DB Proxy</text>
    <text x="1250" y="245" text-anchor="middle" font-size="12" fill="#424242">• Abstracts sharding complexity</text>
    <text x="1250" y="265" text-anchor="middle" font-size="12" fill="#424242">• Manages connection pooling</text>
    <text x="1250" y="285" text-anchor="middle" font-size="12" fill="#424242">• Routes queries by hash key</text>
    
    <!-- Analytics Note -->
    <rect x="900" y="800" width="200" height="100" rx="5" ry="5" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="1"/>
    <text x="1000" y="820" text-anchor="middle" font-size="16" font-weight="bold" fill="#424242">Analytics</text>
    <text x="1000" y="845" text-anchor="middle" font-size="12" fill="#424242">• Decoupled from core service</text>
    <text x="1000" y="865" text-anchor="middle" font-size="12" fill="#424242">• Async processing via queue</text>
    <text x="1000" y="885" text-anchor="middle" font-size="12" fill="#424242">• Separate database for scaling</text>
    
    <!-- Data Flow Note -->
    <rect x="650" y="800" width="200" height="100" rx="5" ry="5" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="1"/>
    <text x="750" y="820" text-anchor="middle" font-size="16" font-weight="bold" fill="#424242">Data Flows</text>
    <text x="750" y="845" text-anchor="middle" font-size="12" fill="#00695c">• Cache operations (green)</text>
    <text x="750" y="865" text-anchor="middle" font-size="12" fill="#e65100">• Database operations (orange)</text>
    <text x="750" y="885" text-anchor="middle" font-size="12" fill="#ad1457">• Event publishing (pink)</text>
    
    <!-- Legend -->
    <rect x="50" y="900" width="20" height="20" fill="#bbdefb" stroke="#1565c0" stroke-width="2"/>
    <text x="80" y="915" text-anchor="start" font-size="14" fill="#2c3e50">Client</text>
    
    <rect x="50" y="930" width="20" height="20" fill="#ffcc80" stroke="#e65100" stroke-width="2"/>
    <text x="80" y="945" text-anchor="start" font-size="14" fill="#2c3e50">CDN</text>
    
    <rect x="50" y="960" width="20" height="20" fill="#ce93d8" stroke="#7b1fa2" stroke-width="2"/>
    <text x="80" y="975" text-anchor="start" font-size="14" fill="#2c3e50">API Gateway</text>
    
    <rect x="50" y="990" width="20" height="20" fill="#c5e1a5" stroke="#33691e" stroke-width="2"/>
    <text x="80" y="1005" text-anchor="start" font-size="14" fill="#2c3e50">URL Services</text>
    
    <rect x="50" y="1020" width="20" height="20" fill="#b2dfdb" stroke="#00695c" stroke-width="2"/>
    <text x="80" y="1035" text-anchor="start" font-size="14" fill="#2c3e50">Redis Cache</text>
    
    <rect x="300" y="900" width="20" height="20" fill="#ffe0b2" stroke="#e65100" stroke-width="2"/>
    <text x="330" y="915" text-anchor="start" font-size="14" fill="#2c3e50">DB Proxy</text>
    
    <circle cx="310" cy="945" r="10" fill="#ffecb3" stroke="#ff6f00" stroke-width="2"/>
    <text x="330" y="950" text-anchor="start" font-size="14" fill="#2c3e50">Database</text>
    
    <rect x="300" y="960" width="20" height="20" fill="#c8e6c9" stroke="#2e7d32" stroke-width="2"/>
    <text x="330" y="975" text-anchor="start" font-size="14" fill="#2c3e50">Message Queue</text>
    
    <rect x="300" y="990" width="20" height="20" fill="#f8bbd0" stroke="#ad1457" stroke-width="2"/>
    <text x="330" y="1005" text-anchor="start" font-size="14" fill="#2c3e50">Analytics Service</text>
    
    <rect x="300" y="1020" width="20" height="20" fill="#ffecb3" stroke="#ff6f00" stroke-width="2"/>
    <text x="330" y="1035" text-anchor="start" font-size="14" fill="#2c3e50">Auth Service</text>
</svg>